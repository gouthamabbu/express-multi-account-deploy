name: Build and Deploy Express App

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: "Where to deploy"
        required: true
        type: choice
        options:
          - account-a
          - account-b
          - both

permissions:
  id-token: write
  contents: read

env:
  APP_TAG: express
  CONTAINER_NAME: app
  APP_PORT: "3000"
  HOST_PORT: "80"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # =========================
      # ACCOUNT A
      # =========================
      - name: Configure AWS (Account A)
        if: inputs.deploy_target == 'account-a' || inputs.deploy_target == 'both'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_ACCOUNT_A }}
          aws-region: ${{ secrets.AWS_REGION_ACCOUNT_A }}

      - name: Build & Push Image (Account A)
        if: inputs.deploy_target == 'account-a' || inputs.deploy_target == 'both'
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION_ACCOUNT_A }} \
          | docker login --username AWS --password-stdin ${{ secrets.ECR_URI_ACCOUNT_A }}

          docker build -t ${{ secrets.ECR_URI_ACCOUNT_A }}:${{ github.sha }} .
          docker push ${{ secrets.ECR_URI_ACCOUNT_A }}:${{ github.sha }}

      - name: Deploy via SSM (Account A)
        if: inputs.deploy_target == 'account-a' || inputs.deploy_target == 'both'
        run: |
          aws ssm send-command \
            --targets "Key=tag:App,Values=${APP_TAG}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Express App - Account A" \
            --parameters commands="[
              \"aws ecr get-login-password --region ${{ secrets.AWS_REGION_ACCOUNT_A }} | docker login --username AWS --password-stdin ${{ secrets.ECR_URI_ACCOUNT_A }}\",
              \"docker pull ${{ secrets.ECR_URI_ACCOUNT_A }}:${{ github.sha }}\",
              \"docker rm -f ${CONTAINER_NAME} || true\",
              \"docker run -d --restart unless-stopped --name ${CONTAINER_NAME} -p ${HOST_PORT}:${APP_PORT} ${{ secrets.ECR_URI_ACCOUNT_A }}:${{ github.sha }}\"
            ]"

      # =========================
      # ACCOUNT B
      # =========================
      - name: Configure AWS (Account B)
        if: inputs.deploy_target == 'account-b' || inputs.deploy_target == 'both'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_ACCOUNT_B }}
          aws-region: ${{ secrets.AWS_REGION_ACCOUNT_B }}

      - name: Build & Push Image (Account B)
        if: inputs.deploy_target == 'account-b' || inputs.deploy_target == 'both'
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION_ACCOUNT_B }} \
          | docker login --username AWS --password-stdin ${{ secrets.ECR_URI_ACCOUNT_B }}

          docker build -t ${{ secrets.ECR_URI_ACCOUNT_B }}:${{ github.sha }} .
          docker push ${{ secrets.ECR_URI_ACCOUNT_B }}:${{ github.sha }}

      - name: Deploy via SSM (Account B)
        if: inputs.deploy_target == 'account-b' || inputs.deploy_target == 'both'
        run: |
          aws ssm send-command \
            --targets "Key=tag:App,Values=${APP_TAG}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Express App - Account B" \
            --parameters commands="[
              \"aws ecr get-login-password --region ${{ secrets.AWS_REGION_ACCOUNT_B }} | docker login --username AWS --password-stdin ${{ secrets.ECR_URI_ACCOUNT_B }}\",
              \"docker pull ${{ secrets.ECR_URI_ACCOUNT_B }}:${{ github.sha }}\",
              \"docker rm -f ${CONTAINER_NAME} || true\",
              \"docker run -d --restart unless-stopped --name ${CONTAINER_NAME} -p ${HOST_PORT}:${APP_PORT} ${{ secrets.ECR_URI_ACCOUNT_B }}:${{ github.sha }}\"
            ]"